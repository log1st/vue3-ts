image: docker/compose:latest
services:
  - docker:dind
stages:
  - deploy

step-deploy-prod:
  stage: deploy
  script:
    #- docker stop node-server
    #- docker rm node-server
    - docker build -t app/node-web-app .
    - docker run --name node-server -p 49162:8080 -p 49164:8081 -d app/node-web-app:latest sh -c 'npm run serve'
  only:
    - master
  tags:
    - master
  variables:
    ENVIRONMENT: production


step-deploy-dev:
  stage: deploy
  script:
    - docker stop node-server
    - docker rm node-server
    - docker build -t app/node-web-app .
    - docker run --name node-server -p 49162:8080 -p 49164:8081 -d app/node-web-app:latest sh -c 'npm run serve'
  only:
    - dev
  tags:
    - dev
  variables:
    ENVIRONMENT: development
